<h1><%= @song.name %></h1>
<% if @song.artist.image.attached? %>
    <%= image_tag @song.artist.image, width: 100  %>
<% end %>
<h4>by <%= link_to @song.artist.name, artist_path(@song.artist) %></h4>
<h5>
<%= @song.genres.pluck(:name).join(", ") %>
</h5>
<div>
    <% if @song.song_file.attached? %>
        <audio controls>
            <source src=<%= url_for(@song.song_file) %> type="audio/mpeg">
            <source src=<%= url_for(@song.song_file) %> type="audio/ogg">
            <source src=<%= url_for(@song.song_file) %> type="audio/mpeg">
        </audio>
    <% end %>
</div>
<p><%= @song.description %></p>
<h4>Price: $<%= "%.2f" % @song.price %> <button id="buynow-button">BUY!</button></h4>
<h4>Exclusive Purchase Price: $<%= "%.2f" % @song.exclusive_price %></h4>
<% if @song.artist.user_id == current_user.id %>
    <p><%= link_to "Edit", edit_song_path(@song) %></p>
    <p><%= link_to "Delete", song_path(@song), method: :delete, data: { confirm: "Are you sure?" } %></p>
<% end %>

<script src="https://js.stripe.com/v3/"></script>

<script>
    const stripe = Stripe("<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>")
    const buyButton = document.getElementById('buynow-button')

    buyButton.addEventListener('click', function() {
        fetch('<%= buy_path(@song.id) %>', {
            method: 'POST'
        })
        .then(function(response) {
            return response.json()
        })
        .then(function(session) {
            return stripe.redirectToCheckout({ sessionId: session.id })
        })
    })
</script>